<script>
let imagenPegada = null;

const sedesInfo = {
  "Sede Am√©ricas": {
    direccion: "CL 20 (Avenida de las Am√©ricas) # 43A - 32 - Bogot√° D.C.",
    mapa: "https://maps.app.goo.gl/F71EgmnxAHW5rnng6"
  },
  "Piso 2 - Altos del Bosque": {
    direccion: "Cra. 43A #6 Sur-15, Medell√≠n, Antioquia",
    mapa: "https://maps.app.goo.gl/2CVYgyfW13oxLkWg8"
  },
  "Piso 5 - Forest Medical Center": {
    direccion: "Cra 19 # 82-85, Bogot√° D.C.",
    mapa: "https://maps.app.goo.gl/Qe4uTbU3roaa6VFN6"
  },
  "Piso 6 - Forest Medical Center": {
    direccion: "Cra 19 # 82-85, Bogot√° D.C.",
    mapa: "https://maps.app.goo.gl/Qe4uTbU3roaa6VFN6"
  },
  "Calle 26 - Edificio Elemento": {
    direccion: "Avenida El Dorado # 69 - 76, Bogot√° D.C.",
    mapa: "https://maps.app.goo.gl/DSvCvM1gR2Th4YNY6"
  }
};

function generarCamposFechas() {
  const cantidad = parseInt(document.getElementById("cantidad").value) || 0;
  const contenedor = document.getElementById("contenedorFechas");
  contenedor.innerHTML = "";

  for (let i = 0; i < cantidad; i++) {
    const div = document.createElement("div");
    div.className = "col-6";

    const label = document.createElement("label");
    label.innerText = `Fecha y hora Cita ${i + 1}:`;
    const input = document.createElement("input");
    input.type = "datetime-local";
    input.classList.add("fecha-cita");

    div.appendChild(label);
    div.appendChild(input);
    contenedor.appendChild(div);
  }
}

document.addEventListener("paste", function (e) {
  const items = e.clipboardData.items;
  for (let item of items) {
    if (item.type.indexOf("image") !== -1) {
      const blob = item.getAsFile();
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.src = event.target.result;
        document.getElementById("imageContainer").innerHTML = "";
        document.getElementById("imageContainer").appendChild(img);
        imagenPegada = img.src;
      };
      reader.readAsDataURL(blob);
    }
  }
});

function generarConfirmacion() {
  const sede = document.getElementById("sede").value;
  const cantidad = parseInt(document.getElementById("cantidad").value);
  const especialidad = document.getElementById("especialidad").value;
  const fechas = document.querySelectorAll(".fecha-cita");

  if (!sede || !cantidad || !especialidad || fechas.length !== cantidad || !imagenPegada) {
    alert("‚ö†Ô∏è Por favor complete todos los campos y pegue una imagen.");
    return;
  }

  const direccion = sedesInfo[sede]?.direccion || "Direcci√≥n no disponible";
  const mapa = sedesInfo[sede]?.mapa || "#";

  const listaFechas = Array.from(fechas).map((el, i) => {
    const fecha = new Date(el.value);
    if (isNaN(fecha)) return `‚Ä¢ Cita ${i + 1}: Fecha no v√°lida`;
    const texto = fecha.toLocaleString("es-CO", {
      weekday: "long", year: "numeric", month: "long", day: "numeric",
      hour: "numeric", minute: "2-digit"
    });
    return `‚Ä¢ Cita ${i + 1}: ${texto}`;
  }).join("<br>");

  const html = `
    <p>üì¢ A continuaci√≥n, le compartimos la confirmaci√≥n de su cita para que pueda asistir:</p>
    <p>üìç <strong>Sede:</strong> ${sede}</p>
    <p>üè¢ <strong>Direcci√≥n:</strong> ${direccion}</p>
    <p>üåê <strong>¬øC√≥mo llegar?:</strong> <a href="${mapa}" target="_blank">${mapa}</a></p>
    <p>üìÖ <strong>Fechas y horas de las citas:</strong><br>${listaFechas}</p>
    <p>ü©∫ <strong>Especialidad:</strong> ${especialidad}</p>
    <p>üñºÔ∏è <strong>Confirmaci√≥n de Cita:</strong></p>
    <img src="${imagenPegada}" style="max-width:100%; max-height:300px; object-fit:contain; border:1px solid #ccc;">
  `;

  document.getElementById("output").innerHTML = html;
}

function copiarConfirmacion() {
  const output = document.getElementById("output");
  const range = document.createRange();
  range.selectNode(output);
  const selection = window.getSelection();
  selection.removeAllRanges();
  selection.addRange(range);
  document.execCommand("copy");
  selection.removeAllRanges();
  alert("‚úÖ Confirmaci√≥n copiada al portapapeles.");
}

function limpiarCampos() {
  document.getElementById("sede").value = "";
  document.getElementById("cantidad").value = "";
  document.getElementById("especialidad").value = "";
  document.getElementById("contenedorFechas").innerHTML = "";
  document.getElementById("imageContainer").innerHTML = "Pega aqu√≠ tu imagen";
  document.getElementById("output").innerHTML = "";
  imagenPegada = null;
}

// NUEVO: Capturar datos de URL
window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const servicio = params.get("service");
  const tipoDoc = params.get("tdoc");
  const documento = params.get("doc");
  const telefono = params.get("telefono");

  if (servicio) document.getElementById("servicio").value = decodeURIComponent(servicio);
  if (tipoDoc) document.getElementById("tipoDocumento").value = decodeURIComponent(tipoDoc);
  if (documento) document.getElementById("numeroDocumento").value = decodeURIComponent(documento);
  if (telefono) document.getElementById("telefono").value = decodeURIComponent(telefono);
});
</script>
